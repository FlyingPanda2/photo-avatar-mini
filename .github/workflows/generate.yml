name: Generate Image
on:
  repository_dispatch:
    types: [generate-image]

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: gh-pages
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install replicate

      - name: Generate image with Replicate
        id: generate
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          node -e "
          const Replicate = require('replicate');
          const crypto = require('crypto');
          
          const replicate = new Replicate({
            auth: process.env.REPLICATE_API_TOKEN,
          });
          
          const input = JSON.parse('${{ github.event.client_payload.input }}');
          const style = input.style || 'anime';
          const prompt = input.prompt || '';
          
          const prompts = {
            'anime': 'anime illustration, detailed eyes, vibrant colors, manga style, professional artwork, high quality, 4k',
            'pixel': 'pixel art, 8-bit, 16-bit retro game style, isometric, colorful, detailed, video game aesthetic',
            'vintage': 'vintage polaroid photo, 1970s, film grain, warm colors, nostalgic, faded, aged photo, retro'
          };
          
          const fullPrompt = (prompts[style] || prompts['anime']) + (prompt ? '. ' + prompt : '');
          
          (async () => {
            try {
              const output = await replicate.run(
                'stability-ai/stable-diffusion-3',
                {
                  input: {
                    prompt: fullPrompt,
                    image_dimensions: '512x512',
                    num_inference_steps: 25,
                    guidance_scale: 7.5,
                  }
                }
              );
              
              const imageUrl = Array.isArray(output) ? output[0] : output;
              const hash = crypto.randomBytes(8).toString('hex');
              const filename = 'generated-' + hash + '.jpg';
              
              console.log('IMAGE_URL=' + imageUrl);
              console.log('FILENAME=' + filename);
            } catch (error) {
              console.error('ERROR:', error.message);
              process.exit(1);
            }
          })();
          "

      - name: Download generated image
        if: success()
        run: |
          curl -o generated-image.jpg "${{ env.IMAGE_URL }}"
          
      - name: Commit and push image
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p generated
          cp generated-image.jpg "generated/$(date +%s)-${{ github.event.client_payload.hash }}.jpg"
          git add generated/
          git commit -m "Generated image: ${{ github.event.client_payload.input }}"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages
